<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Management - Networking CRM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ffffff;
            --primary-dark: #d1d5db;
            --primary-light: #9ca3af;
            --bg-primary: #191919;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a1;
            --text-tertiary: #6b7280;
            --border-color: #373737;
            --border-light: #2a2a2a;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.4;
            font-weight: 400;
            font-size: 13px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .app-layout {
            display: flex;
            min-height: 100vh;
            gap: 0;
        }

        /* Left Command Center Sidebar - Arc-style auto-hide */
        .command-center {
            position: fixed;
            left: 0;
            top: 0;
            width: 60px;
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: width 0.2s ease;
            overflow: hidden;
        }

        .command-center:hover,
        .command-center.expanded {
            width: 200px;
        }

        .command-center.expanded {
            width: 200px;
        }

        .command-center-content {
            padding: 20px 12px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .command-tab {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }

        .command-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .command-tab.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .command-tab-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 18px;
        }

        .command-tab-label {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .command-center:hover .command-tab-label,
        .command-center.expanded .command-tab-label {
            opacity: 1;
        }

        .main-content {
            flex: 1;
            padding: 32px 40px;
            margin-left: 60px;
            overflow-x: auto;
            transition: margin-left 0.2s ease;
        }

        .command-center:hover ~ .main-content,
        .command-center.expanded ~ .main-content {
            margin-left: 200px;
        }

        /* Tab Content Areas */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Remove old sidebar */
        .sidebar {
            display: none;
        }

        header {
            margin-bottom: 32px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            letter-spacing: -0.3px;
        }

        header p {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 400;
            margin-bottom: 20px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--text-primary);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--text-secondary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--border-color);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .filters {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--text-secondary);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        input::placeholder {
            color: var(--text-tertiary);
        }

        .contacts-table {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-primary);
        }

        th {
            padding: 8px 12px;
            text-align: left;
            font-weight: 500;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            position: relative;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--bg-tertiary);
        }

        th.filterable {
            padding-right: 28px;
        }

        .filter-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }

        th.filter-active .filter-icon {
            opacity: 1;
            color: var(--text-primary);
        }

        th.filter-active {
            background: var(--bg-tertiary);
        }

        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            padding: 8px;
            margin-top: 4px;
        }

        .filter-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
        }

        .filter-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .filter-dropdown-item input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .filter-dropdown-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            text-transform: none;
            letter-spacing: 0;
            font-weight: 400;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            white-space: nowrap;
        }

        tbody tr {
            transition: background 0.15s ease;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Status colors matching Notion - adjusted for dark theme */
        .status-wait { background: #3a3a3a; color: #d1d5db; }
        .status-queued { background: #3a3a3a; color: #d1d5db; }
        .status-need_to_contact { background: #7f1d1d; color: #fecaca; }
        .status-contacted { background: #1e3a8a; color: #bfdbfe; }
        .status-circle_back { background: #6b21a8; color: #e9d5ff; }
        .status-scheduled { background: #78350f; color: #fde68a; }
        .status-done { background: #065f46; color: #a7f3d0; }
        .status-ghosted { background: #374151; color: #d1d5db; }

        /* Type badge colors matching Notion - adjusted for dark theme */
        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .type-existing { background: #78350f; color: #fde68a; }
        .type-2026_new { background: #065f46; color: #a7f3d0; }

        /* Group badge colors matching Notion - adjusted for dark theme */
        .group-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .group-other { background: #3a3a3a; color: #d1d5db; }
        .group-fam { background: #78350f; color: #fde68a; }
        .group-McK { background: #3a3a3a; color: #d1d5db; }
        .group-PEA { background: #7f1d1d; color: #fecaca; }
        .group-GU { background: #1e3a8a; color: #bfdbfe; }
        .group-BP { background: #065f46; color: #a7f3d0; }
        .group-MBA { background: #6b21a8; color: #e9d5ff; }
        .group-MVNX { background: #78350f; color: #fde68a; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 14px;
            font-size: 12px;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .sidebar-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-item {
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stat-section {
            margin-bottom: 20px;
        }

        .stat-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .quick-action-btn {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .quick-action-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .draft-modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border-color);
        }

        .draft-content {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin: 16px 0;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-primary);
            max-height: 300px;
            overflow-y: auto;
        }

        .draft-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: none;
            letter-spacing: 0;
        }

        .form-group.required label::after {
            content: " *";
            color: #ef4444;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        
        .form-row .form-group {
            margin-bottom: 0;
        }
        
        .form-row .form-group input,
        .form-row .form-group select {
            width: 100%;
        }

        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        textarea:focus {
            outline: none;
            border-color: var(--text-secondary);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .error {
            background: #7f1d1d;
            color: #fecaca;
            padding: 12px 14px;
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid #991b1b;
            font-size: 13px;
        }

        .success {
            background: #065f46;
            color: #a7f3d0;
            padding: 12px 14px;
            border-radius: 6px;
            margin-bottom: 16px;
            border: 1px solid #047857;
            font-size: 13px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--text-secondary);
        }

            @media (max-width: 1024px) {
            .command-center {
                width: 200px;
            }

            .main-content {
                margin-left: 200px;
            }
        }

        /* Ensure all text uses Inter */
        input, select, textarea, button, label, th, td, h1, h2, h3, p, span, div {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        /* Mailbox Tab Styles */
        .mailbox-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .mailbox-panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mailbox-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .mailbox-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .mailbox-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .mailbox-item:hover {
            background: var(--bg-tertiary);
        }

        .mailbox-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .mailbox-item-from {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
        }

        .mailbox-item-date {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .mailbox-item-subject {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .mailbox-item-preview {
            font-size: 12px;
            color: var(--text-tertiary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* History Thread Styles */
        .history-thread {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .thread-header {
            padding: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.15s ease;
        }

        .thread-header:hover {
            background: var(--bg-secondary);
        }

        .thread-icon {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .thread-header.expanded .thread-icon {
            transform: rotate(90deg);
        }

        .thread-title {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .thread-meta {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: auto;
        }

        .thread-subject {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }

        .thread-content {
            padding: 0 12px 12px 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 0;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 2000px;
            }
        }

        .thread-message {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-top: 12px;
        }

        .unknown-contact {
            font-size: 11px;
            color: var(--text-tertiary);
            font-style: italic;
            margin-left: 8px;
        }

        /* Reply Modal Styles */
        .original-email-preview {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .original-email-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 0;
            text-decoration: underline;
        }

        .original-email-toggle:hover {
            color: var(--text-primary);
        }

        .original-email-content {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Stats Tab Styles */
        .stats-container {
            display: grid;
            gap: 24px;
        }

        .stats-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .stats-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .stat-card-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Left Command Center -->
    <div class="command-center" id="commandCenter">
        <div class="command-center-content">
            <div class="command-tab active" onclick="switchMainTab('rolodex')" data-tab="rolodex">
                <div class="command-tab-icon">ðŸ“‡</div>
                <div class="command-tab-label">Rolodex</div>
            </div>
            <div class="command-tab" onclick="switchMainTab('mailbox')" data-tab="mailbox">
                <div class="command-tab-icon">ðŸ“¬</div>
                <div class="command-tab-label">Mailbox</div>
            </div>
            <div class="command-tab" onclick="switchMainTab('stats')" data-tab="stats">
                <div class="command-tab-icon">ðŸ“Š</div>
                <div class="command-tab-label">Stats</div>
            </div>
        </div>
    </div>

    <div class="app-layout">
        <div class="main-content">
            <!-- Rolodex Tab -->
            <div id="rolodexTab" class="tab-content active">
                <header>
                    <h1>Contact Management</h1>
                    <p>Manage your networking contacts with Notion integration</p>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openAddModal()">+ Add Contact</button>
                        <button class="btn btn-secondary" onclick="loadContacts(true)">Refresh</button>
                    </div>
                </header>

                <div id="message"></div>

                <div class="filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="search" placeholder="Search name, email, company..." oninput="applyFilters()">
                    </div>
                </div>
            </div>

            <div class="contacts-table">
                <div id="contacts-container">
                    <div class="loading">Loading contacts...</div>
                </div>
            </div>
            </div>

            <!-- Mailbox Tab -->
            <div id="mailboxTab" class="tab-content">
                <header>
                    <h1>Mailbox</h1>
                    <p>View inbox and outbox messages</p>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="syncAllEmails()">Sync Email</button>
                    </div>
                </header>

                <div id="message-mailbox"></div>

                <div class="mailbox-container">
                    <div class="mailbox-panel">
                        <div class="mailbox-header">Inbox (CRM Responses)</div>
                        <div class="mailbox-list" id="inboxList">
                            <div class="loading">Loading inbox...</div>
                        </div>
                    </div>
                    <div class="mailbox-panel">
                        <div class="mailbox-header">Outbox (CRM Sent)</div>
                        <div class="mailbox-list" id="outboxList">
                            <div class="loading">Loading outbox...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="statsTab" class="tab-content">
                <header>
                    <h1>Statistics</h1>
                    <p>View your networking statistics</p>
                </header>

                <div class="stats-container">
                    <div class="stats-section">
                        <div class="stats-section-title" id="stats-2026-title">2026 Stats</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-label">Outbounds</div>
                                <div class="stat-card-value" id="stat-2026-outbounds">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Calls</div>
                                <div class="stat-card-value" id="stat-2026-calls">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="stats-section">
                        <div class="stats-section-title" id="this-month-title">This Month Stats</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-card-label">Outbounds</div>
                                <div class="stat-card-value" id="stat-month-outbounds">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-card-label">Calls</div>
                                <div class="stat-card-value" id="stat-month-calls">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Contact</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="contactForm" onsubmit="saveContact(event)">
                <input type="hidden" id="contactId">
                
                <div class="form-group required">
                    <label>Name</label>
                    <input type="text" id="name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="form_status">
                            <option value="wait">Wait</option>
                            <option value="queued" selected>Queued</option>
                            <option value="need_to_contact">Need to Contact</option>
                            <option value="contacted">Contacted</option>
                            <option value="circle_back">Circle Back</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="done">Done</option>
                            <option value="ghosted">Ghosted</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="form_type">
                            <option value="">-- Select --</option>
                            <option value="existing">Existing</option>
                            <option value="2026_new">2026 New</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Group</label>
                        <select id="form_group">
                            <option value="">-- Select --</option>
                            <option value="Fam">Family</option>
                            <option value="McK">McKinsey</option>
                            <option value="PEA">Exeter</option>
                            <option value="GU">Georgetown</option>
                            <option value="BP">Berkshire</option>
                            <option value="MBA">MBA</option>
                            <option value="MVNX">Mavnox</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>LinkedIn URL</label>
                        <input type="url" id="linkedin_url">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" id="company">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" id="title">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="location">
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" id="deleteContactBtn" class="btn btn-danger" onclick="deleteContactFromModal()" style="display: none;">Delete</button>
                    <button type="submit" class="btn btn-primary">Save Contact</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="viewDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewDetailsTitle">Contact Details</h2>
                <button class="close-btn" onclick="closeViewDetailsModal()">&times;</button>
            </div>
            <div id="viewDetailsContent" style="max-height: 70vh; overflow-y: auto;">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div id="viewDetailsActions" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 16px;">
                <button type="button" class="btn btn-secondary" onclick="closeViewDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Send Draft Modal -->
    <div id="sendModal" class="modal">
        <div class="modal-content draft-modal-content">
            <div class="modal-header">
                <h2 id="sendModalTitle">Draft Message</h2>
                <button class="close-btn" onclick="closeSendModal()">&times;</button>
            </div>
            <div id="draftType" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;"></div>
            <div class="draft-content" id="draftContent"></div>
            <div class="draft-actions">
                <button type="button" class="btn btn-secondary" onclick="closeSendModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyDraft()">Copy to Clipboard</button>
            </div>
        </div>
    </div>

    <!-- Send Email Modal -->
    <div id="sendEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Email</h2>
                <button class="close-btn" onclick="document.getElementById('sendEmailModal').classList.remove('active')">&times;</button>
            </div>
            <form onsubmit="sendEmail(event)">
                <input type="hidden" id="sendEmailContactId">
                <div class="form-group">
                    <label>To</label>
                    <div id="sendEmailTo" style="color: var(--text-primary); padding: 8px; background: var(--bg-tertiary); border-radius: 4px;"></div>
                </div>
                <div class="form-group">
                    <label>From Account</label>
                    <select id="sendEmailFromAccount" required style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                        <option value="">Loading accounts...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subject</label>
                    <input type="text" id="sendEmailSubject" required style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Body</label>
                    <textarea id="sendEmailBody" required rows="10" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('sendEmailModal').classList.remove('active')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Email</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reply Email Modal -->
    <div id="replyEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="replyEmailTitle">Reply to Contact</h2>
                <button class="close-btn" onclick="closeReplyModal()">&times;</button>
            </div>
            <div class="original-email-preview">
                <button type="button" class="original-email-toggle" onclick="toggleOriginalEmail()" id="toggleOriginalBtn">Show Original Email</button>
                <div class="original-email-content" id="originalEmailContent" style="display: none;">
                    <div style="margin-bottom: 8px;">
                        <strong>From:</strong> <span id="originalEmailFrom"></span><br>
                        <strong>Date:</strong> <span id="originalEmailDate"></span><br>
                        <strong>Subject:</strong> <span id="originalEmailSubject"></span>
                    </div>
                    <div id="originalEmailBody" style="border-top: 1px solid var(--border-color); padding-top: 8px; margin-top: 8px;"></div>
                </div>
            </div>
            <form onsubmit="sendReplyEmail(event)">
                <input type="hidden" id="replyEmailContactId">
                <input type="hidden" id="replyMessageId">
                <div class="form-group">
                    <label>To</label>
                    <div id="replyEmailTo" style="color: var(--text-primary); padding: 8px; background: var(--bg-tertiary); border-radius: 4px;"></div>
                </div>
                <div class="form-group">
                    <label>From Account</label>
                    <select id="replyEmailFromAccount" required style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                        <option value="">Loading accounts...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Subject</label>
                    <input type="text" id="replyEmailSubject" required style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="replyEmailBody" required rows="10" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" onclick="regenerateReply()">Regenerate Reply</button>
                    <button type="button" class="btn btn-secondary" onclick="closeReplyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Reply</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send SMS Modal -->
    <div id="sendSMSModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Send Text Message</h2>
                <button class="close-btn" onclick="document.getElementById('sendSMSModal').classList.remove('active')">&times;</button>
            </div>
            <form onsubmit="sendSMS(event)">
                <input type="hidden" id="sendSMSContactId">
                <div class="form-group">
                    <label>To</label>
                    <div id="sendSMSTo" style="color: var(--text-primary); padding: 8px; background: var(--bg-tertiary); border-radius: 4px;"></div>
                </div>
                <div class="form-group">
                    <label>Message</label>
                    <textarea id="sendSMSBody" required rows="6" style="width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">SMS messages are limited to 1600 characters</div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('sendSMSModal').classList.remove('active')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Text</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let allContacts = [];
        let activeFilters = {
            status: [],
            type: [],
            group: [],
            company: []
        };
        let openFilterDropdown = null;

        async function loadContacts(forceRefresh = false) {
            const container = document.getElementById('contacts-container');
            if (!container) {
                console.error('Contacts container not found');
                return;
            }
            
            container.innerHTML = '<div class="loading">Loading contacts...</div>';

            try {
                // Add refresh parameter if force refresh is requested
                const url = forceRefresh ? `${API_BASE}/contacts?refresh=true` : `${API_BASE}/contacts`;
                console.log('Fetching contacts from:', url);
                console.log('Full URL:', window.location.origin + url);
                
                // Add timeout to detect if server is not responding
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                console.log('Response status:', response.status, response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    let errorText = '';
                    let errorDetail = null;
                    try {
                        errorText = await response.text();
                        try {
                            errorDetail = JSON.parse(errorText);
                        } catch (e) {
                            // Not JSON, use as-is
                        }
                    } catch (e) {
                        errorText = 'Could not read error message';
                    }
                    
                    const detailMessage = errorDetail?.detail || errorText;
                    throw new Error(`Failed to load contacts: ${response.status} ${response.statusText}. ${detailMessage}`);
                }
                
                const responseText = await response.text();
                console.log('Response text length:', responseText.length);
                console.log('Response text preview:', responseText.substring(0, 200));
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text:', responseText);
                    throw new Error(`Failed to parse JSON response: ${parseError.message}`);
                }
                
                console.log('Received contacts:', data?.length || 0);
                console.log('First contact sample:', data[0]);
                
                if (!Array.isArray(data)) {
                    console.error('Invalid response format:', data);
                    throw new Error('Invalid response format: expected array');
                }
                
                allContacts = data;
                console.log('Loaded', allContacts.length, 'contacts');
                console.log('About to call updateStats, buildFilterOptions, applyFilters');
                
                if (allContacts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No contacts found</h3>
                            <p>Your Notion database appears to be empty, or no contacts match the current filters.</p>
                            <button class="btn btn-primary" onclick="openAddModal()" style="margin-top: 12px;">Add Your First Contact</button>
                        </div>
                    `;
                    updateStats(allContacts);
                    return;
                }
                
                updateStats(allContacts);
                buildFilterOptions();
                try {
                    applyFilters();
                } catch (error) {
                    console.error('Error in applyFilters:', error);
                    container.innerHTML = `
                        <div class="error">
                            <h3>Error displaying contacts</h3>
                            <p>${error.message}</p>
                            <p style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                                Check the browser console (F12) for more details.
                            </p>
                            <button class="btn btn-primary" onclick="loadContacts()" style="margin-top: 12px;">Retry</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
                let errorMessage = error.message || 'Unknown error occurred';
                
                // Provide more helpful error messages
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. The server may not be running or is taking too long to respond.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Cannot connect to the server. Make sure the server is running on port 8000.';
                }
                
                container.innerHTML = `
                    <div class="error">
                        <h3>Error loading contacts</h3>
                        <p>${errorMessage}</p>
                        <p style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                            <strong>Troubleshooting:</strong><br>
                            â€¢ Make sure the server is running: <code>python main.py</code><br>
                            â€¢ Check that NOTION_API_KEY and NOTION_DATABASE_ID are set in your .env file<br>
                            â€¢ Check the browser console (F12) for more details
                        </p>
                        <button class="btn btn-primary" onclick="loadContacts()" style="margin-top: 12px;">Retry</button>
                    </div>
                `;
            }
        }

        function buildFilterOptions() {
            // Extract unique values for each filterable column
            const statusOptions = [...new Set(allContacts.map(c => c.status).filter(Boolean))];
            const typeOptions = [...new Set(allContacts.map(c => c.type).filter(Boolean))];
            const groupOptions = [...new Set(allContacts.map(c => c.group).filter(Boolean))];
            const companyOptions = [...new Set(allContacts.map(c => c.company).filter(Boolean))].sort();

            // Store for filter dropdowns
            window.filterOptions = {
                status: statusOptions,
                type: typeOptions,
                group: groupOptions,
                company: companyOptions
            };
        }

        function toggleFilterDropdown(column, event) {
            if (event) {
                event.stopPropagation();
            }

            // Close other dropdowns
            if (openFilterDropdown && openFilterDropdown !== column) {
                closeFilterDropdown();
            }

            if (openFilterDropdown === column) {
                closeFilterDropdown();
                return;
            }

            openFilterDropdown = column;
            const th = document.querySelector(`th[data-column="${column}"]`);
            if (!th) return;

            // Remove existing dropdown
            const existing = th.querySelector('.filter-dropdown');
            if (existing) {
                existing.remove();
                return;
            }

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'filter-dropdown';
            dropdown.setAttribute('data-column', column);
            dropdown.onclick = (e) => e.stopPropagation();

            const options = window.filterOptions[column] || [];
            const activeValues = activeFilters[column] || [];

            options.forEach(option => {
                const item = document.createElement('div');
                item.className = 'filter-dropdown-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `filter-${column}-${option}`;
                checkbox.checked = activeValues.includes(option);
                checkbox.onchange = (e) => {
                    e.stopPropagation();
                    toggleFilterValue(column, option);
                };

                const label = document.createElement('label');
                label.htmlFor = `filter-${column}-${option}`;
                label.textContent = formatFilterValue(column, option);

                item.appendChild(checkbox);
                item.appendChild(label);
                dropdown.appendChild(item);
            });

            // Add clear button if filters are active
            if (activeValues.length > 0) {
                const clearItem = document.createElement('div');
                clearItem.className = 'filter-dropdown-item';
                clearItem.style.borderTop = '1px solid var(--border-color)';
                clearItem.style.marginTop = '4px';
                clearItem.style.paddingTop = '8px';
                clearItem.textContent = 'Clear Filter';
                clearItem.style.fontWeight = '500';
                clearItem.onclick = (e) => {
                    e.stopPropagation();
                    activeFilters[column] = [];
                    closeFilterDropdown();
                    applyFilters();
                };
                dropdown.appendChild(clearItem);
            }

            th.appendChild(dropdown);

            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeOnOutsideClick(e) {
                    if (!th.contains(e.target)) {
                        closeFilterDropdown();
                        document.removeEventListener('click', closeOnOutsideClick);
                    }
                }, { once: true });
            }, 0);
        }

        function closeFilterDropdown() {
            if (openFilterDropdown) {
                const th = document.querySelector(`th[data-column="${openFilterDropdown}"]`);
                if (th) {
                    const dropdown = th.querySelector('.filter-dropdown');
                    if (dropdown) dropdown.remove();
                }
                openFilterDropdown = null;
            }
        }

        function toggleFilterValue(column, value) {
            if (!activeFilters[column]) {
                activeFilters[column] = [];
            }
            const index = activeFilters[column].indexOf(value);
            if (index > -1) {
                activeFilters[column].splice(index, 1);
            } else {
                activeFilters[column].push(value);
            }
            updateFilterIndicator(column);
            applyFilters();
        }

        function updateFilterIndicator(column) {
            const th = document.querySelector(`th[data-column="${column}"]`);
            if (!th) return;

            const activeValues = activeFilters[column] || [];
            if (activeValues.length > 0) {
                th.classList.add('filter-active');
            } else {
                th.classList.remove('filter-active');
            }
        }

        function formatFilterValue(column, value) {
            if (column === 'status') {
                return value.replace(/_/g, ' ');
            }
            return value;
        }

        function applyFilters() {
            const searchElement = document.getElementById('search');
            if (!searchElement) {
                console.error('Search element not found');
                return;
            }
            const search = searchElement.value.toLowerCase();
            
            let filtered = allContacts.filter(contact => {
                // Search filter
                if (search) {
                    const searchable = [
                        contact.name || '',
                        contact.email || '',
                        contact.phone || '',
                        contact.company || '',
                        contact.notes || ''
                    ].join(' ').toLowerCase();
                    if (!searchable.includes(search)) {
                        return false;
                    }
                }

                // Status filter
                if (activeFilters.status.length > 0) {
                    if (!activeFilters.status.includes(contact.status)) {
                        return false;
                    }
                }

                // Type filter
                if (activeFilters.type.length > 0) {
                    if (!activeFilters.type.includes(contact.type)) {
                        return false;
                    }
                }

                // Group filter
                if (activeFilters.group.length > 0) {
                    if (!activeFilters.group.includes(contact.group)) {
                        return false;
                    }
                }

                // Company filter
                if (activeFilters.company.length > 0) {
                    if (!activeFilters.company.includes(contact.company)) {
                        return false;
                    }
                }

                return true;
            });

            displayContacts(filtered);
        }

        function displayContacts(contacts) {
            console.log('displayContacts called with', contacts.length, 'contacts');
            const container = document.getElementById('contacts-container');
            if (!container) {
                console.error('contacts-container element not found!');
                return;
            }
            
            if (contacts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No contacts found</h3>
                        <p>Add your first contact to get started!</p>
                    </div>
                `;
                updateStats(contacts);
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="filterable" data-column="status" onclick="toggleFilterDropdown('status', event)">
                                Status
                                <span class="filter-icon">ðŸ”½</span>
                            </th>
                            <th class="filterable" data-column="type" onclick="toggleFilterDropdown('type', event)">
                                Type
                                <span class="filter-icon">ðŸ”½</span>
                            </th>
                            <th class="filterable" data-column="group" onclick="toggleFilterDropdown('group', event)">
                                Group
                                <span class="filter-icon">ðŸ”½</span>
                            </th>
                            <th class="filterable" data-column="company" onclick="toggleFilterDropdown('company', event)">
                                Company
                                <span class="filter-icon">ðŸ”½</span>
                            </th>
                            <th>Last Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            contacts.forEach(contact => {
                const statusClass = contact.status ? `status-${contact.status}` : '';
                const statusText = contact.status ? contact.status.replace(/_/g, ' ') : 'N/A';
                
                // Type badge
                let typeBadge = '-';
                if (contact.type) {
                    const typeClass = contact.type === 'existing' ? 'type-existing' : 'type-2026_new';
                    const typeText = contact.type === '2026_new' ? '2026 New' : 'Existing';
                    typeBadge = `<span class="type-badge ${typeClass}">${typeText}</span>`;
                }
                
                // Group badge
                let groupBadge = '-';
                if (contact.group) {
                    // Normalize and clean the group value for display (remove any parentheses)
                    const cleanedGroup = normalizeGroupValue(contact.group);
                    // Normalize group name for class matching (handle both Notion values and display names)
                    const groupLower = cleanedGroup.toLowerCase();
                    let groupClass = 'group-other';
                    if (groupLower === 'fam' || groupLower === 'family') groupClass = 'group-fam';
                    else if (groupLower === 'mck' || groupLower === 'mckinsey') groupClass = 'group-McK';
                    else if (groupLower === 'pea' || groupLower === 'phillips exeter academy' || groupLower === 'exeter') groupClass = 'group-PEA';
                    else if (groupLower === 'gu' || groupLower === 'georgetown' || groupLower === 'georgetown university') groupClass = 'group-GU';
                    else if (groupLower === 'bp' || groupLower === 'berkshire partners' || groupLower === 'berkshire') groupClass = 'group-BP';
                    else if (groupLower === 'mba') groupClass = 'group-MBA';
                    else if (groupLower === 'mvnx' || groupLower === 'mavnox') groupClass = 'group-MVNX';
                    else if (groupLower === 'other') groupClass = 'group-other';
                    
                    // Display the cleaned group value (no parentheses)
                    groupBadge = `<span class="group-badge ${groupClass}">${cleanedGroup}</span>`;
                }
                
                html += `
                    <tr>
                        <td><strong style="cursor: pointer; color: var(--text-primary); text-decoration: underline;" onclick="viewContactDetails('${contact.id}')" title="Click to view details">${contact.name || 'N/A'}</strong></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${typeBadge}</td>
                        <td>${groupBadge}</td>
                        <td>${contact.company || '-'}</td>
                        <td>${contact.last_contact_date || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="openDraftModal('${contact.id}')">Draft</button>
                                <button class="btn btn-primary btn-small" onclick="openSendEmailForm('${contact.id}')">Send</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            updateStats(contacts);
            
            // Update filter indicators after rendering
            Object.keys(activeFilters).forEach(column => {
                updateFilterIndicator(column);
            });
        }

        function updateStats(contacts) {
            // Get current month name
            const now = new Date();
            const currentMonth = now.toLocaleString('default', { month: 'long' });
            const currentYear = now.getFullYear();
            document.getElementById('this-month-title').textContent = `${currentMonth} ${currentYear} Stats`;

            // Calculate 2026 stats (all contacts with last_contact_date in 2026)
            const contacts2026 = contacts.filter(c => {
                if (!c.last_contact_date) return false;
                const date = new Date(c.last_contact_date);
                return date.getFullYear() === 2026;
            });

            // Calculate this month stats
            const contactsThisMonth = contacts.filter(c => {
                if (!c.last_contact_date) return false;
                const date = new Date(c.last_contact_date);
                return date.getFullYear() === currentYear && date.getMonth() === now.getMonth();
            });

            // Outbounds = contacted + scheduled + done + ghosted + circle_back
            const outboundStatuses = ['contacted', 'scheduled', 'done', 'ghosted', 'circle_back'];
            
            const outbounds2026 = contacts2026.filter(c => outboundStatuses.includes(c.status)).length;
            const calls2026 = contacts2026.filter(c => c.status === 'done').length;

            const outboundsMonth = contactsThisMonth.filter(c => outboundStatuses.includes(c.status)).length;
            const callsMonth = contactsThisMonth.filter(c => c.status === 'done').length;

            document.getElementById('stat-2026-outbounds').textContent = outbounds2026;
            document.getElementById('stat-2026-calls').textContent = calls2026;
            document.getElementById('stat-month-outbounds').textContent = outboundsMonth;
            document.getElementById('stat-month-calls').textContent = callsMonth;
        }

        function filterByStatus(status) {
            activeFilters.status = [status];
            updateFilterIndicator('status');
            applyFilters();
        }

        function clearFilters() {
            document.getElementById('search').value = '';
            activeFilters = {
                status: [],
                type: [],
                group: [],
                company: []
            };
            Object.keys(activeFilters).forEach(column => {
                updateFilterIndicator(column);
            });
            closeFilterDropdown();
            applyFilters();
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Contact';
            document.getElementById('contactForm').reset();
            document.getElementById('contactId').value = '';
            // Hide delete button in add mode
            document.getElementById('deleteContactBtn').style.display = 'none';
            document.getElementById('contactModal').classList.add('active');
        }

        function deleteContactFromModal() {
            const contactId = document.getElementById('deleteContactBtn').getAttribute('data-contact-id');
            if (!contactId) return;
            
            if (!confirm('Are you sure you want to delete this contact?')) {
                return;
            }

            deleteContact(contactId);
        }

        function normalizeGroupValue(groupValue) {
            // Normalize group value to match Notion values exactly (case-sensitive for Notion)
            if (!groupValue) return '';
            // Strip all trailing parentheses, brackets, and whitespace - be aggressive about cleaning
            let cleaned = groupValue.toString().trim()
                .replace(/[\)\]]+$/g, '')  // Remove trailing ) or ]
                .replace(/\([^)]*\)$/g, '')  // Remove trailing parenthetical content like (text)
                .trim();
            const groupLower = cleaned.toLowerCase();
            const groupMap = {
                'fam': 'Fam',
                'family': 'Fam',
                'mck': 'McK',
                'mckinsey': 'McK',
                'mckinsey)': 'McK',  // Handle trailing parenthesis
                'pea': 'PEA',
                'phillips exeter academy': 'PEA',
                'exeter': 'PEA',
                'gu': 'GU',
                'georgetown': 'GU',
                'georgetown university': 'GU',
                'bp': 'BP',
                'berkshire partners': 'BP',
                'berkshire': 'BP',
                'mba': 'MBA',
                'mvnx': 'MVNX',
                'mavnox': 'MVNX',
                'other': 'Other'
            };
            // Check if it's already a valid Notion value (exact match, case-sensitive)
            const validNotionValues = ['Fam', 'McK', 'PEA', 'GU', 'BP', 'MBA', 'MVNX', 'Other'];
            if (validNotionValues.includes(cleaned)) {
                return cleaned;
            }
            // Try exact match first
            if (groupMap[groupLower]) {
                return groupMap[groupLower];
            }
            // Try partial match
            for (const [key, value] of Object.entries(groupMap)) {
                if (groupLower.includes(key) || key.includes(groupLower)) {
                    return value;
                }
            }
            // If no match, return cleaned original (might be a new group value)
            return cleaned;
        }

        async function editContact(id) {
            // Fetch fresh contact data from API to ensure we have all fields
            try {
                const response = await fetch(`${API_BASE}/contacts/${id}`);
                if (!response.ok) {
                    showMessage('Contact not found', 'error');
                    return;
                }
                const contact = await response.json();

                document.getElementById('modalTitle').textContent = 'Edit Contact';
                document.getElementById('contactId').value = contact.id;
                document.getElementById('name').value = contact.name || '';
                document.getElementById('email').value = contact.email || '';
                document.getElementById('phone').value = contact.phone || '';
                document.getElementById('form_status').value = contact.status || 'queued';
                document.getElementById('form_type').value = contact.type || '';
                // Normalize group value to match select options
                document.getElementById('form_group').value = normalizeGroupValue(contact.group) || '';
                document.getElementById('title').value = contact.title || '';
                document.getElementById('company').value = contact.company || '';
                document.getElementById('location').value = contact.location || '';
                document.getElementById('linkedin_url').value = contact.linkedin_url || '';
                document.getElementById('notes').value = contact.notes || '';

                // Show delete button in edit mode
                document.getElementById('deleteContactBtn').style.display = 'inline-flex';
                document.getElementById('deleteContactBtn').setAttribute('data-contact-id', contact.id);

                document.getElementById('contactModal').classList.add('active');
            } catch (error) {
                showMessage(`Error loading contact: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function closeModal() {
            document.getElementById('contactModal').classList.remove('active');
        }

        async function saveContact(event) {
            event.preventDefault();
            
            const id = document.getElementById('contactId').value;
            const contactData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                status: document.getElementById('form_status').value,
                type: document.getElementById('form_type').value || null,
                group: document.getElementById('form_group').value || null,
                title: document.getElementById('title').value || null,
                company: document.getElementById('company').value || null,
                location: document.getElementById('location').value || null,
                linkedin_url: document.getElementById('linkedin_url').value || null,
                notes: document.getElementById('notes').value || null,
            };

            // Remove null/empty values
            Object.keys(contactData).forEach(key => {
                if (contactData[key] === '' || contactData[key] === null) {
                    delete contactData[key];
                }
            });

            try {
                const url = id ? `${API_BASE}/contacts/${id}` : `${API_BASE}/contacts`;
                const method = id ? 'PATCH' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contactData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save contact');
                }

                showMessage(id ? 'Contact updated successfully!' : 'Contact created successfully!', 'success');
                closeModal();
                loadContacts();
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        async function deleteContact(id) {
            try {
                const response = await fetch(`${API_BASE}/contacts/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete contact');
                }

                showMessage('Contact deleted successfully!', 'success');
                closeModal();
                loadContacts();
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        // Map group abbreviations to full names (use natural, shorter names)
        // This maps Notion values to display names for personalization
        function getGroupFullName(group) {
            if (!group) return null;
            const groupMap = {
                'BP': 'Berkshire',  // Not "Berkshire Partners"
                'PEA': 'Exeter',     // Not "Phillips Exeter Academy"
                'GU': 'Georgetown',  // Not "Georgetown University"
                'McK': 'McKinsey',
                'MBA': 'HBS',
                'MVNX': 'Mavnox',
                'Fam': 'Family',
                'fam': 'Family',  // Handle lowercase for backward compatibility
                'Other': 'Other',
                'other': 'Other'  // Handle lowercase for backward compatibility
            };
            return groupMap[group] || group;
        }

        // Extract key details from notes for personalization
        function extractPersonalizationFromNotes(notes) {
            if (!notes) return null;
            // Look for key phrases that indicate topics, interests, or context
            const noteText = notes.toLowerCase();
            const personalization = {
                topics: [],
                interests: [],
                context: notes, // Full notes for context
                mutualConnections: [],
                specificAdvice: null
            };
            
            // Extract potential topics (AI, investing, etc.)
            const topicKeywords = [
                { keyword: 'ai', display: 'AI' },
                { keyword: 'artificial intelligence', display: 'AI' },
                { keyword: 'investing', display: 'investing' },
                { keyword: 'venture capital', display: 'venture capital' },
                { keyword: 'startup', display: 'startups' },
                { keyword: 'founder', display: 'founding' },
                { keyword: 'founded', display: 'founding' },
                { keyword: 'business', display: 'entrepreneurship' },
                { keyword: 'entrepreneur', display: 'entrepreneurship' },
                { keyword: 'board', display: 'boards' },
                { keyword: 'transition', display: 'transitions' }
            ];
            
            topicKeywords.forEach(({ keyword, display }) => {
                if (noteText.includes(keyword) && !personalization.topics.includes(display)) {
                    personalization.topics.push(display);
                }
            });
            
            // Extract mutual connections (common names)
            const commonNames = ['vivek', 'robert', 'will', 'charlie', 'adi', 'phillip'];
            commonNames.forEach(name => {
                if (noteText.includes(name)) {
                    personalization.mutualConnections.push(name.charAt(0).toUpperCase() + name.slice(1));
                }
            });
            
            // Look for specific advice or quotes in notes (often in quotes or after "said")
            const adviceMatch = notes.match(/(?:said|mentioned|advised|suggested)[^.]{0,100}/i);
            if (adviceMatch) {
                personalization.specificAdvice = adviceMatch[0].trim();
            }
            
            return personalization;
        }

        // Determine if this is a new or existing contact
        function isNewContact(contact) {
            // If type is 'existing', it's not new
            if (contact.type === 'existing') {
                return false;
            }
            // If type is '2026_new' but has last_contact_date, treat as existing
            if (contact.type === '2026_new' && contact.last_contact_date) {
                return false;
            }
            // If type is '2026_new' and no last_contact_date, it's new
            if (contact.type === '2026_new' && !contact.last_contact_date) {
                return true;
            }
            // Default: if no type specified, check last_contact_date
            return !contact.last_contact_date;
        }

        // Determine formality level based on title and company
        function isFormalContact(contact) {
            if (!contact.title) return false;
            const titleLower = contact.title.toLowerCase();
            const companyLower = (contact.company || '').toLowerCase();
            
            // Check for senior roles
            if (titleLower.includes('senior partner') || 
                titleLower.includes('managing director') ||
                titleLower.includes('ceo') ||
                titleLower.includes('president') ||
                titleLower.includes('c-level') ||
                titleLower.includes('chief')) {
                return true;
            }
            
            // Check for prestigious companies
            if (companyLower.includes('mckinsey') || 
                companyLower.includes('bain') || 
                companyLower.includes('bcg') ||
                companyLower.includes('goldman') ||
                companyLower.includes('morgan stanley')) {
                return true;
            }
            
            return false;
        }

        // Generate personalized connection context (DEPRECATED - now handled inline)
        function generateConnectionContext(contact, isNew) {
            // This function is kept for backwards compatibility but is no longer used
            // Draft generation now happens inline in openSendModal
            return '';
        }

        // Generate personalized interest/topic from notes and profile (DEPRECATED - now handled inline)
        function generateInterestContext(contact, isNew) {
            // This function is kept for backwards compatibility but is no longer used
            // Draft generation now happens inline in openSendModal
            return '';
        }

        // Calculate days since last contact
        function getDaysSinceLastContact(contact) {
            if (!contact.last_contact_date) return null;
            const lastContact = new Date(contact.last_contact_date);
            const now = new Date();
            const diffTime = Math.abs(now - lastContact);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }

        // Check if it's been more than 6 months since last contact
        function isLongTimeSinceContact(contact) {
            const daysSince = getDaysSinceLastContact(contact);
            return daysSince !== null && daysSince > 180; // 6 months = ~180 days
        }

        // Generate personalized content based on contact data and time
        // NOTE: All generated messages must follow the 4 Composition Rules:
        // 1. Once-Only Rule: Never use the same key noun/phrase twice (check before finalizing)
        // 2. Update-First Logic: For existing contacts, include personal update before ask
        // 3. Group Name Safety: Only reference network if Group is valid (not 'Other' or blank)
        // 4. CTA Standard: Email uses "15 mins" or "brief call", Text uses "10-minute call" or "quick call in coming days"
        function generatePersonalizedContent(contact, isNew, messageType, timeVariation = 0) {
            const firstName = contact.name ? contact.name.split(' ')[0] : 'there';
            const groupFullName = getGroupFullName(contact.group);
            const notes = extractPersonalizationFromNotes(contact.notes);
            const notesText = (contact.notes || '').toLowerCase();
            
            // Personalization data
            const personalization = {
                firstName: firstName,
                group: groupFullName || contact.group || '',
                company: contact.company || '',
                title: contact.title || '',
                location: contact.location || '',
                notes: notes,
                notesText: notesText,
                // Time-based variation seed (0 = first time, 1+ = variations)
                variation: timeVariation
            };

            // Extract specific observation from notes
            personalization.specificObservation = '';
            if (notesText.includes('cornerstone') || notesText.includes('found') || notesText.includes('founded')) {
                if (timeVariation === 0) {
                    personalization.specificObservation = 'Saw your path from Cornerstone to starting your own venturesâ€”rare to see that jump.';
                } else {
                    personalization.specificObservation = 'Noticed your transition from consulting to building companiesâ€”would love to learn from that experience.';
                }
            } else if (notesText.includes('built') || notesText.includes('business')) {
                if (timeVariation === 0) {
                    personalization.specificObservation = `Noticed you've built multiple businessesâ€”would love to learn from that experience.`;
                } else {
                    personalization.specificObservation = `Your experience building ${contact.company || 'companies'} stands out.`;
                }
            } else if (notesText.includes('transition') || notesText.includes('moved')) {
                personalization.specificObservation = `Noticed your transition into a new roleâ€”would value your perspective on that path.`;
            } else if (contact.company) {
                personalization.specificObservation = `Came across your background at ${contact.company} and thought you'd be great to talk to.`;
            } else {
                personalization.specificObservation = `Came across your profile and thought you'd be great to talk to.`;
            }

            // Generate one-line identity (for cold intro emails)
            personalization.oneLineIdentity = '';
            if (contact.group === 'PEA') {
                personalization.oneLineIdentity = 'heading to Stanford for my MBA this fall';
            } else if (contact.group === 'GU') {
                personalization.oneLineIdentity = 'heading to Stanford for my MBA this fall';
            } else if (contact.group === 'McK') {
                personalization.oneLineIdentity = 'heading to Stanford for my MBA this fall';
            } else if (contact.group === 'MBA') {
                personalization.oneLineIdentity = 'heading to Stanford for my MBA this fall';
            } else if (groupFullName) {
                personalization.oneLineIdentity = 'heading to Stanford for my MBA this fall';
            } else {
                personalization.oneLineIdentity = 'heading to Stanford for my MBA this fall';
            }

            // Generate topic
            personalization.topic = '';
            if (notesText.includes('ai') || notesText.includes('artificial intelligence')) {
                personalization.topic = 'developing AI capability';
            } else if (notesText.includes('startup') || notesText.includes('founder')) {
                personalization.topic = 'starting a business';
            } else if (notesText.includes('operator')) {
                personalization.topic = 'operator paths';
            } else if (notesText.includes('investor') || notesText.includes('vc')) {
                personalization.topic = 'investing and venture capital';
            } else if (contact.company) {
                personalization.topic = `opportunities in ${contact.company}`;
            } else {
                personalization.topic = 'my next chapter';
            }

            return personalization;
        }

        // Generate formal email (Cold Intro) based on new template structure
        function generateFormalEmail(contact, personalization) {
            // Group Name Safety Filter: If Group is 'Other' or blank, don't reference network
            const groupName = personalization.group || '';
            const isValidGroup = groupName && groupName !== 'Other' && groupName !== 'other' && groupName !== '';
            
            // Build subject line: Group Name / Topic
            let subject = '';
            if (isValidGroup) {
                subject = `${groupName} / ${personalization.topic || 'Starting Businesses'}`;
            } else {
                subject = `${personalization.company || 'Hoping to Connect'} / ${personalization.topic || 'Starting Businesses'}`;
            }
            
            // Get previous company/role from notes or use company
            let previousCompany = '';
            if (personalization.notesText.includes('cornerstone')) {
                previousCompany = 'Cornerstone';
            } else if (personalization.notesText.includes('mckinsey')) {
                previousCompany = 'McKinsey';
            } else if (contact.company) {
                previousCompany = contact.company;
            } else {
                previousCompany = 'your previous role';
            }
            
            // Get current company/role - try to infer from notes or use company
            let currentCompany = '';
            if (personalization.notesText.includes('founded') || personalization.notesText.includes('founding')) {
                currentCompany = 'founding your own ventures';
            } else if (contact.company) {
                currentCompany = contact.company;
            } else {
                currentCompany = 'your current role';
            }
            
            // Build one-line identity and current focus
            const oneLineIdentity = personalization.oneLineIdentity || 'heading to Stanford for my MBA this fall';
            const currentFocus = personalization.notesText.includes('ai') ? 'building AI automation consulting' :
                               personalization.notesText.includes('startup') ? 'exploring startup opportunities' :
                               'building AI automation consulting';
            
            // Build topic with "vibe check" language
            const topic = personalization.topic || 'making that jump into entrepreneurship';
            
            // Build body with proper email structure (paragraphs, line breaks, more context)
            let body = '';
            if (isValidGroup) {
                // With group reference - more natural email flow
                body = `Hi ${personalization.firstName} â€“ \n\nSaw your path from ${previousCompany} to ${currentCompany}. I'm a ${groupName} alum ${oneLineIdentity} and I'm currently focused on ${currentFocus}.\n\nWould love to get your "vibe check" on ${topic}. Do you have 15 mins this month?\n\nBest,\nTaylor`;
            } else {
                // Without group reference (Group is 'Other' or blank) - more natural email flow
                body = `Hi ${personalization.firstName} â€“ \n\nI came across your background and saw your path from ${previousCompany} to ${currentCompany}. I'm currently ${oneLineIdentity} and I'm focused on ${currentFocus}.\n\nWould love to get your "vibe check" on ${topic}. Do you have 15 mins this month?\n\nBest,\nTaylor`;
            }

            return { subject, body };
        }

        // Generate casual email (Reconnect) based on new template structure
        function generateCasualEmail(contact, personalization, timeVariation) {
            // Update-First Logic: Always include personal update for existing contacts
            const personalUpdate = "I'm heading to Stanford for business school later this year";
            
            // Build subject: Catching up / Update Topic
            const subject = "Catching up / Stanford update";
            
            // Get company with fallbacks
            const company = contact.company || personalization.company || 'your company';
            
            // Build body with proper email structure (paragraphs, line breaks)
            const body = `Hi ${personalization.firstName} â€“ \n\nIt's been a while! Wanted to share a quick update that ${personalUpdate}.\n\nBefore I head out, I'd love to hear how things are at ${company}. You free for a brief call next week?\n\nBest,\nTaylor`;

            return { subject, body };
        }

        // Generate formal text (Cold Intro) based on new template structure
        function generateFormalText(contact, personalization) {
            // Text CTA Standard: "Would you be open to a 10-minute call in the coming weeks?"
            const company = contact.company || personalization.company || 'your work';
            const topic = personalization.topic || 'developing AI capability';
            
            const text = `Hi ${personalization.firstName}, this is Taylor Walshe. We haven't met, but I've been following your work at ${company}. I'd love to get your perspective on ${topic}. Would you be open to a 10-minute call in the coming weeks?`;

            return text;
        }

        // Generate casual text (Reconnect) based on new template structure
        function generateCasualText(contact, personalization, timeVariation) {
            // Text CTA Standard: "Let me know if you're free for a quick call in the coming days, looking forward to it!"
            const location = personalization.location || contact.location || 'there';
            
            const text = `${personalization.firstName}! Hope ${location} is treating you well. Been too longâ€”would love to catch up and hear what you've been up to. Let me know if you're free for a quick call in the coming days, looking forward to it!`;

            return text;
        }

        function openDraftModal(contactId) {
            // This is the old openSendModal - just generates draft to copy
            openSendModal(contactId);
        }

        function openSendModal(contactId) {
            const contact = allContacts.find(c => c.id === contactId);
            if (!contact) {
                showMessage('Contact not found', 'error');
                return;
            }

            // Determine message type based on contact info (following channel rules)
            const hasEmail = contact.email && contact.email.trim() !== '';
            const hasPhone = contact.phone && contact.phone.trim() !== '';
            
            let messageType = 'email';
            if (hasPhone && hasEmail) {
                // Both available - default to text
                messageType = 'text';
            } else if (hasPhone) {
                messageType = 'text';
            } else if (hasEmail) {
                messageType = 'email';
            } else {
                // Neither - default to email
                messageType = 'email';
            }

            // Determine if this is a new or existing contact
            const isNew = isNewContact(contact);
            
            // Calculate time variation (0 = first time, 1+ = variations for same person over time)
            let timeVariation = 0;
            if (!isNew && contact.last_contact_date) {
                const daysSince = getDaysSinceLastContact(contact);
                // If it's been more than 6 months, use variation 1
                if (daysSince > 180) {
                    timeVariation = 1;
                }
                // If it's been more than a year, use variation 2
                if (daysSince > 365) {
                    timeVariation = 2;
                }
            }

            // Generate personalized content
            const personalization = generatePersonalizedContent(contact, isNew, messageType, timeVariation);
            
            let draftContent = '';

            if (messageType === 'email') {
                document.getElementById('sendModalTitle').textContent = 'Draft Email';
                document.getElementById('draftType').textContent = `To: ${contact.email || 'No email'}`;
                
                if (isNew) {
                    // NEW OUTREACH - Use formal template
                    const email = generateFormalEmail(contact, personalization);
                    draftContent = `Subject: ${email.subject}\n\n${email.body}`;
                } else {
                    // EXISTING CONTACT - Use casual template
                    const email = generateCasualEmail(contact, personalization, timeVariation);
                    draftContent = `Subject: ${email.subject}\n\n${email.body}`;
                }
            } else {
                // TEXT MESSAGE
                document.getElementById('sendModalTitle').textContent = 'Draft Text Message';
                document.getElementById('draftType').textContent = `To: ${contact.phone || 'No phone'}`;
                
                if (isNew && contact.type === '2026_new') {
                    // NEW CONTACT - Use formal text template
                    draftContent = generateFormalText(contact, personalization);
                } else {
                    // EXISTING CONTACT - Use casual text template
                    draftContent = generateCasualText(contact, personalization, timeVariation);
                }
            }

            document.getElementById('draftContent').textContent = draftContent;
            document.getElementById('sendModal').classList.add('active');
        }

        function closeSendModal() {
            document.getElementById('sendModal').classList.remove('active');
        }

        function copyDraft() {
            const draftContent = document.getElementById('draftContent').textContent;
            navigator.clipboard.writeText(draftContent).then(() => {
                showMessage('Draft copied to clipboard!', 'success');
            }).catch(err => {
                showMessage('Failed to copy to clipboard', 'error');
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        let currentViewContactId = null;
        let currentViewTab = 'details';
        let isEditingDetails = false;
        let currentMainTab = 'rolodex';

        async function viewContactDetails(contactId) {
            currentViewContactId = contactId;
            currentViewTab = 'details';
            try {
                const response = await fetch(`${API_BASE}/contacts/${contactId}`);
                if (!response.ok) {
                    showMessage('Contact not found', 'error');
                    return;
                }
                const contact = await response.json();

                document.getElementById('viewDetailsTitle').textContent = contact.name || 'Contact Details';
                
                // Build tabs - use data attributes for reliable matching
                const tabsHTML = `
                    <div style="display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 16px;">
                        <button class="tab-btn" data-tab="details" onclick="switchContactTab('details')" style="padding: 8px 16px; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                            Details
                        </button>
                        <button class="tab-btn" data-tab="history" onclick="switchContactTab('history')" style="padding: 8px 16px; background: none; border: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s;">
                            History
                        </button>
                    </div>
                    <div id="contactTabContent"></div>
                `;
                
                document.getElementById('viewDetailsContent').innerHTML = tabsHTML;
                await renderContactTab(contact);
                document.getElementById('viewDetailsModal').classList.add('active');
            } catch (error) {
                showMessage(`Error loading contact: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function switchContactTab(tab) {
            currentViewTab = tab;
            
            // Update tab buttons immediately for better UX
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                const tabName = btn.getAttribute('data-tab');
                const isActive = tabName === currentViewTab;
                btn.style.borderBottomColor = isActive ? 'var(--primary-color)' : 'transparent';
                btn.style.color = isActive ? 'var(--text-primary)' : 'var(--text-secondary)';
                btn.style.fontWeight = isActive ? '600' : '400';
            });
            
            try {
                const response = await fetch(`${API_BASE}/contacts/${currentViewContactId}`);
                if (!response.ok) {
                    showMessage('Contact not found', 'error');
                    return;
                }
                const contact = await response.json();
                await renderContactTab(contact);
            } catch (error) {
                showMessage(`Error loading contact: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function renderContactTab(contact) {
            const tabContent = document.getElementById('contactTabContent');
            
            if (currentViewTab === 'details') {
                // Build editable form (like Edit modal)
                const statusOptions = ['wait', 'queued', 'need_to_contact', 'contacted', 'circle_back', 'scheduled', 'done', 'ghosted'];
                const typeOptions = ['', 'existing', '2026_new'];
                const groupOptions = ['', 'Fam', 'McK', 'PEA', 'GU', 'BP', 'MBA', 'MVNX', 'Other'];
                
                // Escape HTML to prevent XSS and ensure values display correctly
                const escapeHtml = (text) => {
                    if (text == null || text === undefined) return '';
                    return String(text)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                };
                
                let detailsHTML = `
                    <form id="editContactFormInModal" onsubmit="saveContactFromDetails(event)">
                        <input type="hidden" id="editContactIdInModal" value="${escapeHtml(contact.id)}">
                        
                        <div class="form-row">
                            <div class="form-group required">
                                <label>Name</label>
                                <input type="text" id="editNameInModal" value="${escapeHtml(contact.name || '')}" required>
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="tel" id="editPhoneInModal" value="${escapeHtml(contact.phone || '')}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="editEmailInModal" value="${escapeHtml(contact.email || '')}">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="editTypeInModal">
                                    ${typeOptions.map(opt => {
                                        // Normalize type for comparison: handle both "existing"/"2026_new" and "Existing"/"2026 New"
                                        const contactType = (contact.type || '').toLowerCase().trim();
                                        const optLower = (opt || '').toLowerCase().trim();
                                        const isSelected = contactType === optLower || 
                                                          (contactType === 'existing' && optLower === 'existing') ||
                                                          (contactType === '2026_new' && optLower === '2026_new') ||
                                                          (contactType === '2026 new' && optLower === '2026_new');
                                        return `<option value="${escapeHtml(opt)}" ${isSelected ? 'selected' : ''}>${opt === '2026_new' ? '2026 New' : (opt === 'existing' ? 'Existing' : (opt || '-- Select --'))}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Status</label>
                                <select id="editStatusInModal">
                                    ${statusOptions.map(opt => {
                                        // Normalize status for comparison (handle both formats)
                                        const contactStatus = (contact.status || '').toLowerCase().replace(/\s+/g, '_').trim();
                                        const optLower = opt.toLowerCase().trim();
                                        const isSelected = contactStatus === optLower;
                                        // Display with proper capitalization
                                        const displayText = opt.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                        return `<option value="${escapeHtml(opt)}" ${isSelected ? 'selected' : ''}>${displayText}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>LinkedIn URL</label>
                                <input type="url" id="editLinkedInInModal" value="${escapeHtml(contact.linkedin_url || '')}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Group</label>
                                <select id="editGroupInModal">
                                    ${groupOptions.map(opt => {
                                        // Normalize the contact's group value to remove any parentheses or formatting issues
                                        const normalizedGroup = normalizeGroupValue(contact.group || '');
                                        const isSelected = normalizedGroup === opt;
                                        // Display clean names without any parentheses
                                        const displayName = opt === 'Fam' ? 'Family' : 
                                                          (opt === 'McK' ? 'McKinsey' : 
                                                          (opt === 'PEA' ? 'Exeter' : 
                                                          (opt === 'GU' ? 'Georgetown' : 
                                                          (opt === 'BP' ? 'Berkshire' : 
                                                          (opt === 'MBA' ? 'MBA' : 
                                                          (opt === 'MVNX' ? 'Mavnox' : 
                                                          (opt === 'Other' ? 'Other' : '-- Select --')))))));
                                        return `<option value="${escapeHtml(opt)}" ${isSelected ? 'selected' : ''}>${displayName}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <input type="text" id="editTitleInModal" value="${escapeHtml(contact.title || '')}">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Company</label>
                                <input type="text" id="editCompanyInModal" value="${escapeHtml(contact.company || '')}">
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" id="editLocationInModal" value="${escapeHtml(contact.location || '')}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="editNotesInModal" rows="3">${escapeHtml(contact.notes || '')}</textarea>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
                            <button type="button" class="btn btn-secondary" onclick="cancelEditDetails()">Cancel</button>
                            <button type="button" class="btn btn-danger" onclick="deleteContactFromDetails()">Delete</button>
                            <button type="submit" class="btn btn-primary">Save Contact</button>
                        </div>
                    </form>
                `;
                tabContent.innerHTML = detailsHTML;
                isEditingDetails = true;
            } else if (currentViewTab === 'history') {
                // Load conversation history (read-only list)
                await loadContactHistory(contact);
            }
            
            // Update tab buttons - use data attributes for reliable matching
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                const tabName = btn.getAttribute('data-tab');
                const isActive = tabName === currentViewTab;
                btn.style.borderBottomColor = isActive ? 'var(--primary-color)' : 'transparent';
                btn.style.color = isActive ? 'var(--text-primary)' : 'var(--text-secondary)';
                btn.style.fontWeight = isActive ? '600' : '400';
            });
        }

        async function loadContactHistory(contact) {
            const tabContent = document.getElementById('contactTabContent');
            tabContent.innerHTML = '<div class="loading">Loading conversation history...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/contacts/${contact.id}/messages`);
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                const messages = await response.json();
                
                // Build history HTML with collapsible threads
                let historyHTML = `
                    <div style="display: grid; gap: 16px;">
                        <div style="max-height: 400px; overflow-y: auto;">
                `;
                
                if (messages.length === 0) {
                    historyHTML += `
                        <div style="text-align: center; padding: 32px; color: var(--text-secondary);">
                            <p>No conversations in system.</p>
                        </div>
                    `;
                } else {
                    // Sort messages by date (oldest first for threading)
                    messages.sort((a, b) => {
                        const dateA = new Date(a.sent_at || a.received_at || a.created_at || 0);
                        const dateB = new Date(b.sent_at || b.received_at || b.created_at || 0);
                        return dateA - dateB;
                    });
                    
                    // Group messages into threads by subject (for emails) or date proximity
                    const threads = [];
                    let currentThread = null;
                    
                    messages.forEach(msg => {
                        const isEmail = msg.channel === 'email';
                        const timestamp = msg.sent_at || msg.received_at || msg.created_at;
                        const msgDate = timestamp ? new Date(timestamp) : new Date();
                        
                        // Group by subject if email, or by date if same day
                        if (isEmail && msg.subject) {
                            // Check if this belongs to existing thread with same subject
                            if (currentThread && currentThread.subject === msg.subject) {
                                currentThread.messages.push(msg);
                            } else {
                                // Start new thread
                                currentThread = {
                                    subject: msg.subject,
                                    messages: [msg],
                                    date: msgDate
                                };
                                threads.push(currentThread);
                            }
                        } else {
                            // For SMS or emails without subject, group by date (same day)
                            const msgDateStr = msgDate.toDateString();
                            if (currentThread && currentThread.dateStr === msgDateStr && !currentThread.subject) {
                                currentThread.messages.push(msg);
                            } else {
                                currentThread = {
                                    subject: null,
                                    messages: [msg],
                                    date: msgDate,
                                    dateStr: msgDateStr
                                };
                                threads.push(currentThread);
                            }
                        }
                    });
                    
                    // Sort threads by most recent message (newest first)
                    threads.sort((a, b) => {
                        const lastMsgA = a.messages[a.messages.length - 1];
                        const lastMsgB = b.messages[b.messages.length - 1];
                        const dateA = new Date(lastMsgA.sent_at || lastMsgA.received_at || lastMsgA.created_at || 0);
                        const dateB = new Date(lastMsgB.sent_at || lastMsgB.received_at || lastMsgB.created_at || 0);
                        return dateB - dateA;
                    });
                    
                    // Render threads
                    threads.forEach((thread, threadIndex) => {
                        const lastMsg = thread.messages[thread.messages.length - 1];
                        const lastTimestamp = lastMsg.sent_at || lastMsg.received_at || lastMsg.created_at;
                        const lastDate = lastTimestamp ? new Date(lastTimestamp) : new Date();
                        const dateStr = lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        const threadId = `thread-${threadIndex}`;
                        
                        // Determine thread title
                        let threadTitle = '';
                        if (thread.subject) {
                            threadTitle = `${dateStr} Email Thread`;
                        } else {
                            threadTitle = `${dateStr} Conversation`;
                        }
                        
                        historyHTML += `
                            <div class="history-thread">
                                <div class="thread-header" onclick="toggleThread('${threadId}')" id="header-${threadId}">
                                    <span class="thread-icon">â–¶</span>
                                    <div style="flex: 1;">
                                        <div class="thread-title">${threadTitle}</div>
                                        ${thread.subject ? `<div class="thread-subject">${thread.subject}</div>` : ''}
                                    </div>
                                    <div class="thread-meta">${thread.messages.length} message${thread.messages.length !== 1 ? 's' : ''} â€¢ Last: ${lastDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                                </div>
                                <div class="thread-content" id="content-${threadId}" style="display: none;">
                        `;
                        
                        // Render messages in thread
                        thread.messages.forEach(msg => {
                            const isOutbound = msg.direction === 'outbound';
                            const isEmail = msg.channel === 'email';
                            const fromAccount = msg.from_account || (isOutbound ? msg.from_address : null);
                            const timestamp = msg.sent_at || msg.received_at || msg.created_at;
                            const dateStr = timestamp ? new Date(timestamp).toLocaleString() : '';
                            
                            historyHTML += `
                                <div class="thread-message">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div>
                                            <span style="font-weight: 600; color: var(--text-primary);">
                                                ${isOutbound ? 'â†’ Outbound' : 'â† Inbound'}
                                            </span>
                                            <span style="color: var(--text-secondary); margin-left: 8px;">
                                                ${isEmail ? 'ðŸ“§ Email' : 'ðŸ’¬ SMS'}
                                            </span>
                                        </div>
                                        <span style="font-size: 11px; color: var(--text-tertiary);">${dateStr}</span>
                                    </div>
                                    ${isEmail && msg.subject ? `
                                        <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 8px;">
                                            ${msg.subject}
                                        </div>
                                    ` : ''}
                                    <div style="color: var(--text-secondary); white-space: pre-wrap; font-size: 13px;">
                                        ${msg.body || '(No content)'}
                                    </div>
                                    ${isEmail ? `
                                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                                            ${isOutbound ? `To: ${msg.to_address}` : `From: ${msg.from_address}`}
                                            ${fromAccount && isOutbound ? ` â€¢ Sent from: ${fromAccount}` : ''}
                                        </div>
                                    ` : ''}
                                    ${!isEmail ? `
                                        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                                            ${isOutbound ? `To: ${msg.to_phone}` : `From: ${msg.from_phone}`}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        historyHTML += `
                                </div>
                            </div>
                        `;
                    });
                }
                
                historyHTML += `
                        </div>
                    </div>
                `;
                
                tabContent.innerHTML = historyHTML;
            } catch (error) {
                tabContent.innerHTML = `
                    <div class="error">
                        <p>Error loading conversation history: ${error.message}</p>
                        <button class="btn btn-primary" onclick="switchContactTab('history')" style="margin-top: 12px;">Retry</button>
                    </div>
                `;
            }
        }

        function toggleThread(threadId) {
            const header = document.getElementById(`header-${threadId}`);
            const content = document.getElementById(`content-${threadId}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                header.classList.add('expanded');
            } else {
                content.style.display = 'none';
                header.classList.remove('expanded');
            }
        }

        async function openSendEmailForm(contactId) {
            const contact = allContacts.find(c => c.id === contactId);
            if (!contact || !contact.email) {
                showMessage('Contact has no email address', 'error');
                return;
            }
            
            document.getElementById('sendEmailContactId').value = contactId;
            document.getElementById('sendEmailTo').textContent = contact.email;
            
            // Generate draft content (same logic as openSendModal)
            const isNew = contact.type === '2026_new';
            const timeVariation = 0; // Always use first variation for send form
            const personalization = generatePersonalizedContent(contact, isNew, 'email', timeVariation);
            
            let emailSubject = '';
            let emailBody = '';
            
            if (isNew && contact.type === '2026_new') {
                // NEW CONTACT - Use formal email template
                const email = generateFormalEmail(contact, personalization);
                emailSubject = email.subject;
                emailBody = email.body;
            } else {
                // EXISTING CONTACT - Use casual email template
                const email = generateCasualEmail(contact, personalization, timeVariation);
                emailSubject = email.subject;
                emailBody = email.body;
            }
            
            document.getElementById('sendEmailSubject').value = emailSubject;
            document.getElementById('sendEmailBody').value = emailBody;
            
            // Load available Gmail accounts
            try {
                const response = await fetch(`${API_BASE}/gmail/accounts`);
                const data = await response.json();
                const accounts = data.accounts || [];
                const select = document.getElementById('sendEmailFromAccount');
                select.innerHTML = '';
                if (accounts.length === 0) {
                    select.innerHTML = '<option value="">No Gmail accounts configured</option>';
                } else {
                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('Error loading Gmail accounts:', e);
                document.getElementById('sendEmailFromAccount').innerHTML = '<option value="">Error loading accounts</option>';
            }
            
            document.getElementById('sendEmailModal').classList.add('active');
        }

        function openSendSMSForm(contactId) {
            const contact = allContacts.find(c => c.id === contactId);
            if (!contact || !contact.phone) {
                showMessage('Contact has no phone number', 'error');
                return;
            }
            
            document.getElementById('sendSMSContactId').value = contactId;
            document.getElementById('sendSMSTo').textContent = contact.phone;
            document.getElementById('sendSMSBody').value = '';
            document.getElementById('sendSMSModal').classList.add('active');
        }

        // Helper function to fetch with timeout
        async function fetchWithTimeout(url, options, timeoutMs = 60000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            
            try {
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (error.name === 'AbortError') {
                    throw new Error('Request timed out. Please check your internet connection and try again.');
                }
                throw error;
            }
        }

        async function sendEmail(event) {
            event.preventDefault();
            const contactId = document.getElementById('sendEmailContactId').value;
            const subject = document.getElementById('sendEmailSubject').value;
            const body = document.getElementById('sendEmailBody').value;
            
            if (!subject || !body) {
                showMessage('Subject and body are required', 'error');
                return;
            }
            
            const sendBtn = document.querySelector('#sendEmailModal .btn-primary');
            if (!sendBtn) {
                showMessage('Send button not found', 'error');
                return;
            }
            
            const originalText = sendBtn.textContent;
            const modal = document.getElementById('sendEmailModal');
            
            // Store original state to ensure we can always reset
            let buttonStateReset = false;
            
            const resetButton = () => {
                if (!buttonStateReset && sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = originalText;
                    buttonStateReset = true;
                }
            };
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            const fromAccount = document.getElementById('sendEmailFromAccount').value;
            if (!fromAccount) {
                showMessage('Please select an account to send from', 'error');
                resetButton();
                return;
            }
            
            try {
                // Use fetch with timeout (60 seconds - enough for OAuth flow)
                const response = await fetchWithTimeout(
                    `${API_BASE}/messages/send-email`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contact_id: contactId,
                            subject: subject,
                            body: body,
                            from_account: fromAccount
                        })
                    },
                    60000 // 60 second timeout
                );
                
                if (!response.ok) {
                    let errorMessage = 'Failed to send email';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                        
                        // Provide helpful error messages for common OAuth issues
                        if (errorMessage.includes('redirect_uri_mismatch') || 
                            errorMessage.includes('invalid_request') ||
                            errorMessage.includes('Access blocked')) {
                            errorMessage = 'OAuth authentication failed. Please check that the account is added as a test user in Google Cloud Console and the redirect URI matches. See integrations/email/SETUP.md for details.';
                        }
                    } catch (e) {
                        // If we can't parse the error, use the status text
                        errorMessage = response.statusText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                showMessage('Email sent successfully!', 'success');
                if (modal) {
                    modal.classList.remove('active');
                }
                
                // Auto-update status to "contacted" if needed
                const contact = allContacts.find(c => c.id === contactId);
                if (contact) {
                    const statusesToUpdate = ['need_to_contact', 'wait', 'queued', 'circle_back'];
                    if (statusesToUpdate.includes(contact.status)) {
                        try {
                            await fetchWithTimeout(`${API_BASE}/contacts/${contactId}`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ status: 'contacted' })
                            }, 10000);
                        } catch (e) {
                            console.error('Error updating status:', e);
                        }
                    }
                }
                
                // Reload history if on history tab
                if (currentViewTab === 'history' && currentViewContactId === contactId) {
                    const contact = allContacts.find(c => c.id === contactId);
                    if (contact) {
                        await loadContactHistory(contact);
                    }
                }
                
                // Refresh contacts to update last_contact_date and status
                loadContacts();
                
                // Refresh mailbox if on mailbox tab
                if (currentMainTab === 'mailbox') {
                    loadMailbox();
                }
            } catch (error) {
                console.error('Error sending email:', error);
                let errorMessage = error.message || 'An unexpected error occurred';
                
                // Provide user-friendly error messages
                if (errorMessage.includes('timeout') || errorMessage.includes('timed out')) {
                    errorMessage = 'Request timed out. This may happen if OAuth authentication is required. Please try again and complete the authentication in the browser window that opens.';
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                }
                
                showMessage(`Error: ${errorMessage}`, 'error');
            } finally {
                // Always reset button state, even if there was an error
                resetButton();
            }
        }

        async function sendSMS(event) {
            event.preventDefault();
            const contactId = document.getElementById('sendSMSContactId').value;
            const body = document.getElementById('sendSMSBody').value;
            
            if (!body) {
                showMessage('Message body is required', 'error');
                return;
            }
            
            const sendBtn = document.querySelector('#sendSMSModal .btn-primary');
            if (!sendBtn) {
                showMessage('Send button not found', 'error');
                return;
            }
            
            const originalText = sendBtn.textContent;
            const modal = document.getElementById('sendSMSModal');
            
            // Store original state to ensure we can always reset
            let buttonStateReset = false;
            
            const resetButton = () => {
                if (!buttonStateReset && sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = originalText;
                    buttonStateReset = true;
                }
            };
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            try {
                // Use fetch with timeout (30 seconds for SMS)
                const response = await fetchWithTimeout(
                    `${API_BASE}/messages/send-sms`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contact_id: contactId,
                            body: body
                        })
                    },
                    30000 // 30 second timeout
                );
                
                if (!response.ok) {
                    let errorMessage = 'Failed to send SMS';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (e) {
                        errorMessage = response.statusText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                showMessage('SMS sent successfully!', 'success');
                if (modal) {
                    modal.classList.remove('active');
                }
                
                // Reload messages if on messages tab
                if (currentViewTab === 'messages' && currentViewContactId === contactId) {
                    const contact = allContacts.find(c => c.id === contactId);
                    if (contact) {
                        await loadContactMessages(contact);
                    }
                }
                
                // Refresh contacts to update last_contact_date
                loadContacts();
            } catch (error) {
                console.error('Error sending SMS:', error);
                let errorMessage = error.message || 'An unexpected error occurred';
                
                // Provide user-friendly error messages
                if (errorMessage.includes('timeout') || errorMessage.includes('timed out')) {
                    errorMessage = 'Request timed out. Please check your internet connection and try again.';
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                }
                
                showMessage(`Error: ${errorMessage}`, 'error');
            } finally {
                // Always reset button state, even if there was an error
                resetButton();
            }
        }

        // Reply Email Functions
        let currentReplyMessage = null;
        let currentReplyContact = null;

        async function openReplyModalFromMessage(messageId, contactId) {
            try {
                // Get message from stored mailbox messages (try both string and number key)
                const message = mailboxMessages[messageId] || mailboxMessages[Number(messageId)];
                if (!message) {
                    console.error('Message not found in mailboxMessages. MessageId:', messageId);
                    console.log('Available message IDs:', Object.keys(mailboxMessages));
                    showMessage('Message not found. Please refresh the mailbox.', 'error');
                    return;
                }
                
                // Fetch contact details
                const contactResponse = await fetch(`${API_BASE}/contacts/${contactId}`);
                if (!contactResponse.ok) {
                    throw new Error('Failed to load contact');
                }
                const contact = await contactResponse.json();
                
                await openReplyModalWithData(message, contact);
            } catch (error) {
                console.error('Error opening reply modal:', error);
                showMessage(`Error opening reply: ${error.message}`, 'error');
            }
        }

        async function openReplyModalWithData(message, contact) {
            try {
                
                currentReplyMessage = message;
                currentReplyContact = contact;
                
                // Populate original email preview
                const timestamp = message.received_at || message.sent_at || message.created_at;
                const dateStr = timestamp ? new Date(timestamp).toLocaleString() : '';
                document.getElementById('originalEmailFrom').textContent = message.from_address || 'Unknown';
                document.getElementById('originalEmailDate').textContent = dateStr;
                document.getElementById('originalEmailSubject').textContent = message.subject || '(No subject)';
                document.getElementById('originalEmailBody').textContent = message.body || '(No content)';
                
                // Set form fields
                document.getElementById('replyEmailContactId').value = contact.id;
                document.getElementById('replyMessageId').value = message.id;
                document.getElementById('replyEmailTitle').textContent = `Reply to ${contact.name || 'Contact'}`;
                document.getElementById('replyEmailTo').textContent = contact.email || message.from_address || 'Unknown';
                
                // Generate subject (Re: original subject)
                const originalSubject = message.subject || '';
                const replySubject = originalSubject.toLowerCase().startsWith('re:') 
                    ? originalSubject 
                    : `Re: ${originalSubject}`;
                document.getElementById('replyEmailSubject').value = replySubject;
                
                // Generate suggested reply
                await generateSuggestedReply(message, contact);
                
                // Load available Gmail accounts
                try {
                    const response = await fetch(`${API_BASE}/gmail/accounts`);
                    const data = await response.json();
                    const accounts = data.accounts || [];
                    const select = document.getElementById('replyEmailFromAccount');
                    select.innerHTML = '';
                    if (accounts.length === 0) {
                        select.innerHTML = '<option value="">No Gmail accounts configured</option>';
                    } else {
                        accounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account;
                            option.textContent = account;
                            select.appendChild(option);
                        });
                    }
                } catch (e) {
                    console.error('Error loading Gmail accounts:', e);
                    document.getElementById('replyEmailFromAccount').innerHTML = '<option value="">Error loading accounts</option>';
                }
                
                // Show modal
                document.getElementById('replyEmailModal').classList.add('active');
            } catch (error) {
                showMessage(`Error opening reply: ${error.message}`, 'error');
                console.error('Error opening reply modal:', error);
                throw error;
            }
        }

        function closeReplyModal() {
            document.getElementById('replyEmailModal').classList.remove('active');
            currentReplyMessage = null;
            currentReplyContact = null;
            // Hide original email
            document.getElementById('originalEmailContent').style.display = 'none';
            document.getElementById('toggleOriginalBtn').textContent = 'Show Original Email';
        }

        function toggleOriginalEmail() {
            const content = document.getElementById('originalEmailContent');
            const btn = document.getElementById('toggleOriginalBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide Original Email';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show Original Email';
            }
        }

        async function generateSuggestedReply(originalMessage, contact) {
            // Analyze original message content
            const originalBody = originalMessage.body || '';
            const originalSubject = originalMessage.subject || '';
            
            // Determine if this is a new or existing contact
            const isNew = contact.type === '2026_new';
            
            // Generate personalized content
            const personalization = generatePersonalizedContent(contact, isNew, 'email', 0);
            
            // Build suggested reply based on original message content
            let replyBody = '';
            
            // Extract key information from original message
            const hasQuestion = /[?]/.test(originalBody);
            const isPositive = /(thanks|thank you|great|sounds good|yes|sure|absolutely|definitely)/i.test(originalBody);
            const mentionsMeeting = /(meeting|call|chat|coffee|lunch|dinner|schedule|calendar)/i.test(originalBody);
            
            // Generate appropriate reply
            if (isNew) {
                // New contact - more formal
                replyBody = `Hi ${contact.first_name || contact.name || 'there'},\n\n`;
                if (isPositive && mentionsMeeting) {
                    replyBody += `Great to hear from you! I'd be happy to connect. `;
                } else if (hasQuestion) {
                    replyBody += `Thanks for reaching out. `;
                } else {
                    replyBody += `Thank you for your message. `;
                }
                replyBody += `Let me know what works best for you.\n\n`;
                replyBody += `Best,\n${personalization.your_name || 'Taylor'}`;
            } else {
                // Existing contact - more casual
                const firstName = contact.first_name || contact.name?.split(' ')[0] || 'there';
                replyBody = `Hi ${firstName},\n\n`;
                
                if (isPositive && mentionsMeeting) {
                    replyBody += `Sounds great! Looking forward to it. `;
                } else if (hasQuestion) {
                    replyBody += `Thanks for the note. `;
                } else {
                    replyBody += `Appreciate you reaching out. `;
                }
                
                // Add context-aware response
                if (mentionsMeeting) {
                    replyBody += `Let's get something on the calendar. `;
                }
                
                replyBody += `\nBest,\n${personalization.your_name || 'Taylor'}`;
            }
            
            // If original message has specific questions, try to address them
            if (hasQuestion) {
                const questions = originalBody.match(/[^.!?]*\?/g);
                if (questions && questions.length > 0) {
                    replyBody = `Hi ${contact.first_name || contact.name || 'there'},\n\n`;
                    replyBody += `Thanks for your message. `;
                    replyBody += `I'll get back to you with more details soon.\n\n`;
                    replyBody += `Best,\n${personalization.your_name || 'Taylor'}`;
                }
            }
            
            document.getElementById('replyEmailBody').value = replyBody;
        }

        async function regenerateReply() {
            if (currentReplyMessage && currentReplyContact) {
                await generateSuggestedReply(currentReplyMessage, currentReplyContact);
                showMessage('Reply regenerated', 'success');
            }
        }

        async function sendReplyEmail(event) {
            event.preventDefault();
            const contactId = document.getElementById('replyEmailContactId').value;
            const subject = document.getElementById('replyEmailSubject').value;
            const body = document.getElementById('replyEmailBody').value;
            
            if (!subject || !body) {
                showMessage('Subject and body are required', 'error');
                return;
            }
            
            const sendBtn = document.querySelector('#replyEmailModal .btn-primary');
            if (!sendBtn) {
                showMessage('Send button not found', 'error');
                return;
            }
            
            const originalText = sendBtn.textContent;
            const modal = document.getElementById('replyEmailModal');
            
            let buttonStateReset = false;
            const resetButton = () => {
                if (!buttonStateReset && sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.textContent = originalText;
                    buttonStateReset = true;
                }
            };
            
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            const fromAccount = document.getElementById('replyEmailFromAccount').value;
            if (!fromAccount) {
                showMessage('Please select an account to send from', 'error');
                resetButton();
                return;
            }
            
            try {
                const response = await fetchWithTimeout(
                    `${API_BASE}/messages/send-email`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contact_id: contactId,
                            subject: subject,
                            body: body,
                            from_account: fromAccount
                        })
                    },
                    60000
                );
                
                if (!response.ok) {
                    let errorMessage = 'Failed to send email';
                    try {
                        const error = await response.json();
                        errorMessage = error.detail || errorMessage;
                    } catch (e) {
                        errorMessage = response.statusText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                showMessage('Reply sent successfully!', 'success');
                if (modal) {
                    modal.classList.remove('active');
                }
                
                // Refresh mailbox
                if (currentMainTab === 'mailbox') {
                    loadMailbox();
                }
                
                // Reload contacts
                loadContacts();
                
                // Reload history if viewing this contact
                if (currentViewTab === 'history' && currentViewContactId === contactId) {
                    try {
                        const contact = allContacts.find(c => c.id === contactId);
                        if (contact) {
                            await loadContactHistory(contact);
                        }
                    } catch (e) {
                        console.error('Error reloading history:', e);
                    }
                }
            } catch (error) {
                showMessage(error.message || 'Failed to send reply', 'error');
                resetButton();
            }
        }

        async function syncEmailMessages() {
            const syncBtn = event.target;
            const originalText = syncBtn.textContent;
            syncBtn.disabled = true;
            syncBtn.textContent = 'Syncing...';
            
            try {
                const response = await fetch(`${API_BASE}/messages/sync-email`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to sync emails');
                }
                
                const result = await response.json();
                showMessage(`Synced ${result.synced} new messages`, 'success');
                
                // Reload messages if on messages tab
                if (currentViewTab === 'messages' && currentViewContactId) {
                    const contact = allContacts.find(c => c.id === currentViewContactId);
                    if (contact) {
                        await loadContactMessages(contact);
                    }
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.textContent = originalText;
            }
        }

        function closeViewDetailsModal() {
            document.getElementById('viewDetailsModal').classList.remove('active');
            currentViewContactId = null;
        }

        function editFromViewDetails() {
            if (currentViewContactId) {
                closeViewDetailsModal();
                editContact(currentViewContactId);
            }
        }

        function sendFromViewDetails() {
            if (currentViewContactId) {
                closeViewDetailsModal();
                openSendModal(currentViewContactId);
            }
        }

        // Main tab switching
        function switchMainTab(tabName) {
            currentMainTab = tabName;
            
            // Update command center tabs
            document.querySelectorAll('.command-tab').forEach(tab => {
                if (tab.getAttribute('data-tab') === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Show/hide tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'rolodex') {
                document.getElementById('rolodexTab').classList.add('active');
            } else if (tabName === 'mailbox') {
                document.getElementById('mailboxTab').classList.add('active');
                loadMailbox();
            } else if (tabName === 'stats') {
                document.getElementById('statsTab').classList.add('active');
                updateStats(allContacts);
            }
        }

        // Keep command center expanded when clicking tabs
        document.addEventListener('DOMContentLoaded', function() {
            const commandCenter = document.getElementById('commandCenter');
            const commandTabs = document.querySelectorAll('.command-tab');
            
            commandTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    commandCenter.classList.add('expanded');
                    // Auto-collapse after 2 seconds if not hovering
                    setTimeout(() => {
                        if (!commandCenter.matches(':hover')) {
                            commandCenter.classList.remove('expanded');
                        }
                    }, 2000);
                });
            });
        });

        // Mailbox functions
        let mailboxMessages = {}; // Store messages by ID for quick lookup

        async function loadMailbox() {
            const inboxList = document.getElementById('inboxList');
            const outboxList = document.getElementById('outboxList');
            
            inboxList.innerHTML = '<div class="loading">Loading inbox...</div>';
            outboxList.innerHTML = '<div class="loading">Loading outbox...</div>';
            
            try {
                // Load inbox (CRM responses)
                const inboxResponse = await fetch(`${API_BASE}/messages?crm_responses_only=true&direction=inbound`);
                const inboxMessages = inboxResponse.ok ? await inboxResponse.json() : [];
                
                // Load outbox (CRM sent)
                const outboxResponse = await fetch(`${API_BASE}/messages?crm_sent_only=true&direction=outbound`);
                const outboxMessages = outboxResponse.ok ? await outboxResponse.json() : [];
                
                // Store messages in lookup map (use string keys for consistency)
                mailboxMessages = {};
                [...inboxMessages, ...outboxMessages].forEach(msg => {
                    if (msg.id !== undefined && msg.id !== null) {
                        // Store with both string and number key for compatibility
                        const idKey = String(msg.id);
                        mailboxMessages[idKey] = msg;
                        mailboxMessages[msg.id] = msg; // Also store with numeric key
                    }
                });
                
                // Fetch contact names for all unique contact IDs
                const contactIds = new Set();
                inboxMessages.forEach(msg => { if (msg.contact_id) contactIds.add(msg.contact_id); });
                outboxMessages.forEach(msg => { if (msg.contact_id) contactIds.add(msg.contact_id); });
                
                const contactMap = {};
                // Use existing allContacts array if available, otherwise fetch
                if (allContacts && allContacts.length > 0) {
                    allContacts.forEach(contact => {
                        if (contact.id) contactMap[contact.id] = contact.name;
                    });
                } else {
                    // Fetch contacts for missing ones
                    for (const contactId of contactIds) {
                        if (!contactMap[contactId]) {
                            try {
                                const contactResponse = await fetch(`${API_BASE}/contacts/${contactId}`);
                                if (contactResponse.ok) {
                                    const contact = await contactResponse.json();
                                    contactMap[contactId] = contact.name;
                                }
                            } catch (e) {
                                console.error(`Error fetching contact ${contactId}:`, e);
                            }
                        }
                    }
                }
                
                // Render inbox
                if (inboxMessages.length === 0) {
                    inboxList.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--text-secondary);">No inbox messages</div>';
                } else {
                    let inboxHTML = '';
                    inboxMessages.forEach(msg => {
                        const dateStr = msg.received_at ? new Date(msg.received_at).toLocaleString() : '';
                        const contactName = contactMap[msg.contact_id] || null;
                        const displayName = contactName || msg.from_address || 'Unknown';
                        const unknownIndicator = !contactName ? '<span class="unknown-contact">(Unknown Contact)</span>' : '';
                        // Ensure message ID and contact ID are properly escaped
                        const msgId = msg.id || '';
                        const contactId = msg.contact_id || '';
                        
                        inboxHTML += `
                            <div class="mailbox-item" onclick="openReplyModalFromMessage('${msgId}', '${contactId}')">
                                <div class="mailbox-item-header">
                                    <div class="mailbox-item-from">${displayName}${unknownIndicator}</div>
                                    <div class="mailbox-item-date">${dateStr}</div>
                                </div>
                                <div class="mailbox-item-subject">${msg.subject || '(No subject)'}</div>
                                <div class="mailbox-item-preview">${(msg.body || '').substring(0, 100)}...</div>
                            </div>
                        `;
                    });
                    inboxList.innerHTML = inboxHTML;
                }
                
                // Render outbox
                if (outboxMessages.length === 0) {
                    outboxList.innerHTML = '<div style="text-align: center; padding: 32px; color: var(--text-secondary);">No outbox messages</div>';
                } else {
                    let outboxHTML = '';
                    outboxMessages.forEach(msg => {
                        const dateStr = msg.sent_at ? new Date(msg.sent_at).toLocaleString() : '';
                        const contactName = contactMap[msg.contact_id] || null;
                        const displayName = contactName || msg.to_address || 'Unknown';
                        const unknownIndicator = !contactName ? '<span class="unknown-contact">(Unknown Contact)</span>' : '';
                        
                        outboxHTML += `
                            <div class="mailbox-item" onclick="viewContactDetails('${msg.contact_id}')">
                                <div class="mailbox-item-header">
                                    <div class="mailbox-item-from">${displayName}${unknownIndicator}</div>
                                    <div class="mailbox-item-date">${dateStr}</div>
                                </div>
                                <div class="mailbox-item-subject">${msg.subject || '(No subject)'}</div>
                                <div class="mailbox-item-preview">${(msg.body || '').substring(0, 100)}...</div>
                            </div>
                        `;
                    });
                    outboxList.innerHTML = outboxHTML;
                }
            } catch (error) {
                inboxList.innerHTML = `<div class="error">Error loading inbox: ${error.message}</div>`;
                outboxList.innerHTML = `<div class="error">Error loading outbox: ${error.message}</div>`;
            }
        }

        async function syncAllEmails() {
            const syncBtn = event.target;
            const originalText = syncBtn.textContent;
            syncBtn.disabled = true;
            syncBtn.textContent = 'Syncing...';
            
            try {
                const response = await fetch(`${API_BASE}/messages/sync-email`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to sync emails');
                }
                
                const result = await response.json();
                showMessage(`Synced ${result.synced} new messages`, 'success');
                
                // Reload mailbox
                if (currentMainTab === 'mailbox') {
                    loadMailbox();
                }
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            } finally {
                syncBtn.disabled = false;
                syncBtn.textContent = originalText;
            }
        }

        // Contact details modal functions
        async function saveContactFromDetails(event) {
            event.preventDefault();
            const contactId = document.getElementById('editContactIdInModal').value;
            
            const updateData = {
                name: document.getElementById('editNameInModal').value,
                email: document.getElementById('editEmailInModal').value,
                phone: document.getElementById('editPhoneInModal').value,
                status: document.getElementById('editStatusInModal').value,
                type: document.getElementById('editTypeInModal').value,
                group: document.getElementById('editGroupInModal').value,
                linkedin_url: document.getElementById('editLinkedInInModal').value,
                company: document.getElementById('editCompanyInModal').value,
                title: document.getElementById('editTitleInModal').value,
                location: document.getElementById('editLocationInModal').value,
                notes: document.getElementById('editNotesInModal').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/contacts/${contactId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update contact');
                }
                
                showMessage('Contact updated successfully!', 'success');
                
                // Reload contact and refresh view
                const contact = await response.json();
                await renderContactTab(contact);
                
                // Refresh contacts list
                loadContacts();
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        function cancelEditDetails() {
            if (currentViewContactId) {
                currentViewTab = 'details';
                isEditingDetails = false;
                viewContactDetails(currentViewContactId);
            }
        }

        async function deleteContactFromDetails() {
            const contactId = document.getElementById('editContactIdInModal').value;
            if (!contactId) return;
            
            if (!confirm('Are you sure you want to delete this contact?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/contacts/${contactId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete contact');
                }
                
                showMessage('Contact deleted successfully', 'success');
                closeViewDetailsModal();
                loadContacts();
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
            }
        }

        // Load contacts on page load
        loadContacts();
    </script>
</body>
</html>
